name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history for changelog

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - run: pnpm install
      - run: pnpm build
      - run: npx cap sync android

      - name: Decode keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore

      - name: Build signed APK
        working-directory: android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      - name: Rename APK
        run: mv android/app/build/outputs/apk/release/app-release.apk android/app/build/outputs/apk/release/zulip-notifs-${{ github.ref_name }}.apk

      - name: Generate changelog
        id: changelog
        run: |
          # get last 3 tags for changelog
          TAGS=$(git tag --sort=-creatordate | head -4)
          TAG_ARRAY=($TAGS)
          CHANGELOG=""

          for i in 0 1 2; do
            CURRENT_TAG=${TAG_ARRAY[$i]:-}
            PREV_TAG=${TAG_ARRAY[$((i+1))]:-}

            if [ -z "$CURRENT_TAG" ]; then
              break
            fi

            if [ -z "$PREV_TAG" ]; then
              COMMITS=$(git log --pretty=format:"- %s" --no-merges $CURRENT_TAG)
            else
              COMMITS=$(git log --pretty=format:"- %s" --no-merges ${PREV_TAG}..${CURRENT_TAG})
            fi

            if [ -n "$COMMITS" ]; then
              CHANGELOG="${CHANGELOG}### ${CURRENT_TAG}
          ${COMMITS}

          "
            fi
          done

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GH_PAT }}
          files: android/app/build/outputs/apk/release/zulip-notifs-${{ github.ref_name }}.apk
          body: |
            ## Changes
            ${{ steps.changelog.outputs.commits }}
